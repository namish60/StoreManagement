<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreSphere - Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #1e293b;
            --background: #f8fafc; --text: #0f172a; --white: #ffffff;
            --gray-light: #e2e8f0; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text); min-height: 100vh; padding-bottom: 100px; }
        
        /* Navbar */
        .navbar { background-color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .ss-logo { width: 36px; height: 36px; background: var(--primary); color: var(--white); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1rem; }
        .brand-name { font-family: 'Poppins', sans-serif; font-size: 1.25rem; font-weight: 700; color: var(--text); }
        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-link { cursor: pointer; font-weight: 600; color: #1e293b; }
        .cart-badge { background-color: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; vertical-align: top; margin-left: -5px; }
        
        /* Container */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        
        /* Product Card */
        .product-card { background: var(--white); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); }
        .card-image { height: 200px; background-color: #f1f5f9; display: flex; align-items: center; justify-content: center; position: relative; }
        .card-image img { width: 100%; height: 100%; object-fit: cover; }
        .oos-overlay { position: absolute; background: rgba(255,255,255,0.8); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--danger); }
        .card-content { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
        .product-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .price { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
        .total-display { text-align: right; color: var(--success); font-weight: 600; font-size: 0.9rem; margin-bottom: 10px; }
        .stock-status { font-size: 0.85rem; color: var(--secondary); margin-bottom: 1rem; opacity: 0.8; }
        .stock-status.low { color: var(--warning); font-weight: 600; opacity: 1; }

        /* Buttons */
        .btn-add-cart { margin-top: auto; width: 100%; padding: 0.8rem; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-add-cart:disabled { background-color: var(--gray-light); color: #94a3b8; cursor: not-allowed; }
        
        /* Qty Controls (Main & Modal) */
        .qty-controls { margin-top: auto; display: flex; align-items: center; justify-content: space-between; background-color: #f1f5f9; padding: 5px; border-radius: 8px; }
        .modal-qty-controls { display: flex; align-items: center; gap: 10px; background-color: #f1f5f9; padding: 4px; border-radius: 6px; }
        
        .btn-qty { width: 32px; height: 32px; border-radius: 6px; border: none; background-color: white; color: var(--primary); font-weight: 700; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;}
        .btn-qty:hover { background-color: var(--primary); color: white; }
        .qty-value { font-weight: 600; font-size: 1rem; color: var(--text); }

        /* Sticky Bar */
        .sticky-cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); transform: translateY(100%); transition: transform 0.3s; z-index: 900; }
        .sticky-cart-bar.visible { transform: translateY(0); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 16px; width: 100%; max-width: 550px; max-height: 85vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--gray-light); }
        .item-info h4 { font-size: 1rem; margin-bottom: 4px; }
        .item-info p { font-size: 0.85rem; color: #64748b; }
        .item-actions { display: flex; align-items: center; gap: 15px; }
        
        /* Toast */
        #toast-container { visibility: hidden; min-width: 300px; background-color: var(--success); color: #fff; text-align: center; border-radius: 50px; padding: 16px 24px; position: fixed; z-index: 2000; left: 50%; top: 30px; transform: translateX(-50%); opacity: 0; transition: all 0.5s; }
        #toast-container.show { visibility: visible; opacity: 1; top: 50px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-area">
            <div class="ss-logo">SS</div>
            <span class="brand-name">StoreSphere</span>
        </div>
        <div class="nav-links">
            <span class="nav-link" onclick="openCartModal()">Cart <span class="cart-badge" id="navCartCount">0</span></span>
            <span class="nav-link" onclick="handleNavbarPaymentClick()">Make Payment</span>
        </div>
        <div>
            <span id="userWelcomeMessage" style="font-weight:600; margin-right:15px; color:var(--primary);"></span>
            <button onclick="handleLogout()" style="padding:0.5rem 1rem; border:1px solid #ccc; background:none; border-radius:6px; cursor:pointer;">Sign Out</button>
        </div>
    </nav>

    <div class="container">
        <h2>Available Products</h2>
        <div class="product-grid" id="productGrid">
            <p style="color:#64748b;">Loading products...</p>
        </div>
    </div>

    <div class="sticky-cart-bar" id="stickyCartBar">
        <div style="font-size:1.1rem;">
            <span id="barItemCount">0 items</span> | Total: <span style="font-weight:700; color:var(--primary);" id="barTotalPrice">Rs. 0.00</span>
        </div>
        <button onclick="openCartModal()" style="padding:0.8rem 2rem; background:#1e293b; color:white; border:none; border-radius:8px; cursor:pointer;">View Cart</button>
    </div>

    <!-- Cart Modal -->
    <div class="modal-overlay" id="cartModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:1rem;">
                <h3>Your Cart</h3>
                <button onclick="closeCartModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div id="cartItemsList"></div>
            
            <div style="margin-top:1.5rem; padding-top:1rem; border-top:2px solid #f1f5f9; font-weight:700; display:flex; justify-content:space-between; font-size:1.2rem;">
                <span>Grand Total:</span>
                <span id="modalTotal" style="color:var(--primary);">Rs. 0.00</span>
            </div>
            
            <button onclick="processPayment()" style="width:100%; padding:1rem; background:var(--success); color:white; border:none; border-radius:8px; margin-top:1rem; font-weight:700; cursor:pointer; font-size:1.1rem;">Proceed to Payment</button>
        </div>
    </div>

    <div id="toast-container">Item added to cart!</div>

    <script>
        let products = [];
        let cart = []; 

        document.addEventListener('DOMContentLoaded', () => {
            fetchCurrentUser();
            refreshAll();
        });

        // Combined fetcher to keep state synced
        function refreshAll() {
            return fetchCart().then(() => fetchProducts());
        }

        function fetchCurrentUser() {
            fetch('/api/current_user').then(res => res.json()).then(data => {
                if(data.is_logged_in) document.getElementById('userWelcomeMessage').innerText = `Welcome, ${data.name}`;
                else window.location.href = '/';
            });
        }

        function fetchProducts() {
            return fetch('/api/products').then(res => res.json()).then(data => {
                products = data;
                renderProducts();
            });
        }

        function fetchCart() {
            return fetch('/api/cart').then(res => res.json()).then(data => {
                cart = data;
                updateCartUI();
            });
        }

        // RENDER MAIN GRID
        function renderProducts() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            products.forEach(product => {
                const cartItem = cart.find(c => c.id === product.product_id);
                const isOOS = product.stock === 0;
                
                let imageHtml = product.image_data ? `<img src="${product.image_data}" alt="${product.name}">` : `<div style="font-size:3rem;">ðŸ“¦</div>`;
                if(isOOS) imageHtml += `<div class="oos-overlay">Out of Stock</div>`;

                let footerHtml = '';
                let totalHtml = '';

                if (cartItem && cartItem.qty > 0) {
                    // Qty Controls in Main Grid
                    footerHtml = `
                        <div class="qty-controls">
                            <button class="btn-qty" onclick="updateItemQty('${product.product_id}', 'dec')">-</button>
                            <span class="qty-value">${cartItem.qty} in cart</span>
                            <button class="btn-qty" onclick="updateItemQty('${product.product_id}', 'inc')">+</button>
                        </div>
                    `;
                    totalHtml = `<div class="total-display">Total: Rs. ${(cartItem.price * cartItem.qty).toFixed(2)}</div>`;
                } else {
                    footerHtml = `
                        <button class="btn-add-cart" onclick="addToCart('${product.product_id}')" ${isOOS ? 'disabled' : ''}>
                            ${isOOS ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="card-image">${imageHtml}</div>
                    <div class="card-content">
                        <div class="product-title">${product.name}</div>
                        <div class="price">Rs. ${parseFloat(product.price).toFixed(2)}</div>
                        ${totalHtml}
                        ${footerHtml}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- API ACTIONS ---

        function addToCart(id) {
            const p = products.find(x => x.product_id === id);
            // Check local stock immediately for UI feedback
            if (1 > p.stock) { showToast("Stock limit reached!"); return; }

            fetch('/api/cart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: p.product_id, name: p.name, price: parseFloat(p.price)})
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    refreshAll();
                    showToast("Item added!");
                }
            });
        }

        // UPDATE QTY (Used by both Dashboard and Modal)
        function updateItemQty(id, action) {
            fetch('/api/cart/update_qty', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, action: action})
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    // 1. Fetch updated cart data
                    fetchCart().then(() => {
                        // 2. Update Main Grid
                        renderProducts(); 
                        
                        // 3. Update Modal if it is open (CRITICAL FIX)
                        if(document.getElementById('cartModal').classList.contains('open')) {
                            renderCartList();
                        }
                    });
                } else {
                    showToast(data.message || "Error updating quantity");
                }
            });
        }

        function updateCartUI() {
            const qty = cart.reduce((sum, i) => sum + i.qty, 0);
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            
            document.getElementById('navCartCount').innerText = qty;
            document.getElementById('barItemCount').innerText = `${qty} items`;
            document.getElementById('barTotalPrice').innerText = `Rs. ${total.toFixed(2)}`;
            
            const bar = document.getElementById('stickyCartBar');
            if(qty > 0) bar.classList.add('visible');
            else bar.classList.remove('visible');
        }

        // --- MODAL RENDER LOGIC ---
        function renderCartList() {
            const list = document.getElementById('cartItemsList');
            list.innerHTML = '';
            let grandTotal = 0;

            if(cart.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#64748b; padding:2rem;">Your cart is currently empty.</p>';
                document.getElementById('modalTotal').innerText = 'Rs. 0.00';
                return;
            }

            cart.forEach(item => {
                const total = item.price * item.qty;
                grandTotal += total;
                
                const li = document.createElement('div');
                li.className = 'cart-item';
                // Note: using updateItemQty here too
                li.innerHTML = `
                    <div class="item-info">
                        <h4>${item.name}</h4>
                        <p>Rs. ${item.price.toFixed(2)} each</p>
                    </div>
                    <div class="item-actions">
                        <div class="modal-qty-controls">
                            <button class="btn-qty" onclick="updateItemQty('${item.id}', 'dec')">-</button>
                            <span class="qty-value">${item.qty}</span>
                            <button class="btn-qty" onclick="updateItemQty('${item.id}', 'inc')">+</button>
                        </div>
                        <div style="font-weight:700; width:90px; text-align:right;">Rs. ${total.toFixed(2)}</div>
                    </div>
                `;
                list.appendChild(li);
            });
            document.getElementById('modalTotal').innerText = `Rs. ${grandTotal.toFixed(2)}`;
        }

        function openCartModal() {
            renderCartList(); // Initial render
            document.getElementById('cartModal').classList.add('open');
        }
        function closeCartModal() {
            document.getElementById('cartModal').classList.remove('open');
        }

        function handleNavbarPaymentClick() {
            if(cart.length === 0) showToast("Cart is empty");
            else processPayment();
        }

        function processPayment() {
            if(cart.length === 0) return;
            window.location.href = 'payment.html';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast-container');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function handleLogout() {
            fetch('/api/logout').then(() => window.location.href = '/');
        }
    </script>
</body>
</html>
